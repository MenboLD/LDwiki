<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç·¨é›†ï¼ˆld_usersï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./ld_users_editor.css" />

</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="app-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</div>
        <div class="app-subtitle">ld_usersï¼ˆæ¤œç´¢ â†’ ç·¨é›† â†’ ä¿å­˜ï¼‰</div>
      </div>
      <div id="headerStats" class="app-subtitle"></div>
    </header>

    <main>
      <section id="homeView" class="card">
        <div class="card-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <div class="field">
          <button id="btnGoNew" class="btn-primary">ï¼‹ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</button>
        </div>
        <div class="card-title" style="margin-top:8px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</div>
        <div class="field">
          <div class="search-row">
            <input id="searchNameInput" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆéƒ¨åˆ†ä¸€è‡´å¯ï¼‰" />
            <button id="btnSearch" class="btn-small primary">æ¤œç´¢</button>
          </div>
        </div>
        <div id="searchResults" class="search-results"></div>
      </section>

      <section id="formView" class="card hidden">
        <div id="formModeLabel" class="mode-label"></div>
        <div class="field">
          <label for="inputName">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
          <input id="inputName" type="text" autocomplete="off" />
        </div>
        <div class="field" id="fieldTag">
          <label for="inputTag">è­˜åˆ¥ç•ªå·ï¼ˆ2æ¡ï¼‰</label>
          <input id="inputTag" type="text" maxlength="2" placeholder="00ã€œ99" autocomplete="off" />
        </div>
        <div class="field">
          <label for="selectVaultLevel">é‡‘åº«ãƒ¬ãƒ™ãƒ«ï¼ˆ1ã€œ11ï¼‰</label>
          <select id="selectVaultLevel"></select>
        </div>
        <div class="field">
          <label>ç¥è©±ãƒ¦ãƒ‹ãƒƒãƒˆè‚²æˆçŠ¶æ…‹ï¼ˆç”»åƒä¸€è¦§ï¼‰</label>
          <div id="mythicGrid"></div>
          <div class="mythic-note">
            â€» ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã€‚<br />
            ã€Œå…¨é¸æŠã€ã€Œé¸æŠè§£é™¤ã€ã€ŒLv6/12/15ã€ã€Œå°‚ç”¨ğŸ‘‘ã€ãƒœã‚¿ãƒ³ã§ä¸€æ‹¬å¤‰æ›´ã§ãã¾ã™ã€‚<br />
            ç”»åƒãƒ‘ã‚¹ã¯ <code>ICON_BASE_PATH + "501.png"</code> å½¢å¼ã‚’æƒ³å®šã€‚
          </div>
        </div>
        <div class="status-row">
          <span id="statusComments">ã‚³ãƒ¡æ•°: -</span>
          <span id="statusMisInputs">èª¤å…¥åŠ›: -</span>
          <span id="statusLikes">ã‚¤ã‚¤ã­: -</span>
        </div>
        <div class="btn-row">
          <button id="btnBackHome" class="btn-secondary">æˆ»ã‚‹</button>
          <button id="btnSaveUser" class="btn-primary">ä¿å­˜</button>
        </div>
      </section>
    </main>

    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal">
        <div class="modal-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ç·¨é›†</div>
        <div id="modalBody" class="modal-body"></div>
        <div class="field">
          <label for="modalTagInput">è­˜åˆ¥ç•ªå·ï¼ˆ2æ¡ï¼‰</label>
          <input id="modalTagInput" type="text" maxlength="2" autocomplete="off" />
        </div>
        <div id="modalError" class="modal-body text-danger" style="display:none;"></div>
        <div class="modal-actions">
          <button id="btnModalCancel" class="btn-small">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="btnModalOk" class="btn-small primary">æ±ºå®š</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <script type="module">
    const SUPABASE_URL = "https://teggcuiyqkbcvbhdntni.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlZ2djdWl5cWtiY3ZiaGRudG5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTIyNzUsImV4cCI6MjA4MDE2ODI3NX0.R1p_nZdmR9r4k0fNwgr9w4irkFwp-T8tGiEeJwJioKc";

    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const appState = {
      mode: "home",
      currentUser: null,
      usersCount: null,
    };

    const MYTHIC_IDS = [
      "501","502","503","504","505",
      "506","507","508","509","510",
      "511","512","513","514","515",
      "516","517","518","519","520",
      "521","522","523","524","525",
      "526","527","528"
    ];

    // ä¸æ»…ã¸ã®è¦šé†’ãŒå­˜åœ¨ã™ã‚‹ç¥è©±ID
    const AWAKENABLE_IDS = new Set([
      "501","502","504","506","509","511","513","514","515","516","525","526","527","528"
    ]);

    const ICON_BASE_PATH = "./"; // ä¾‹: "./mythic_icons/" ã« 501.png ãªã©ã‚’ç½®ã

    let multiSelectMode = false;
    let selectedUnitIds = new Set();

    function showToast(message, ms = 2000) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, ms);
    }

    function setView(mode) {
      appState.mode = mode;
      const home = document.getElementById("homeView");
      const form = document.getElementById("formView");
      if (mode === "home") {
        home.classList.remove("hidden");
        form.classList.add("hidden");
      } else {
        home.classList.add("hidden");
        form.classList.remove("hidden");
      }
    }

    function lockEditingFor10Minutes() {
      const lockUntil = Date.now() + 10 * 60 * 1000;
      localStorage.setItem("ld_user_edit_lock_until", String(lockUntil));
    }

    function getEditLockRemainingMs() {
      const raw = localStorage.getItem("ld_user_edit_lock_until");
      if (!raw) return 0;
      const lockUntil = parseInt(raw, 10);
      const now = Date.now();
      return Math.max(0, lockUntil - now);
    }

    function checkEditLocked() {
      const remain = getEditLockRemainingMs();
      if (remain > 0) {
        const minutes = Math.ceil(remain / 60000);
        showToast(`èª¤å…¥åŠ›ãŒç¶šã„ãŸãŸã‚ã€ã‚ã¨ç´„${minutes}åˆ†ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚`, 2500);
        return true;
      }
      return false;
    }

    function formatStatsHeader() {
      const el = document.getElementById("headerStats");
      if (appState.usersCount == null) {
        el.textContent = "";
      } else {
        el.textContent = `ç™»éŒ²æ•°: ${appState.usersCount}`;
      }
    }

    async function fetchUsersCount() {
      const { count, error } = await supabase
        .from("ld_users")
        .select("*", { count: "exact", head: true });
      if (!error) {
        appState.usersCount = count ?? 0;
        formatStatsHeader();
      }
    }

    // ãƒ¦ãƒ‹ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿æç”»
    function renderMythicGrid(mythicState) {
      const container = document.getElementById("mythicGrid");
      container.innerHTML = "";

      const state = mythicState || {};
      selectedUnitIds = new Set();
      multiSelectMode = false;

      const row1 = document.createElement("div");
      row1.className = "unit-controls-row";

      const btnAll = document.createElement("button");
      btnAll.className = "btn-small";
      btnAll.textContent = "å…¨é¸æŠ";
      btnAll.addEventListener("click", () => {
        selectedUnitIds = new Set(MYTHIC_IDS);
        refreshUnitSelectionVisual();
      });

      const btnClear = document.createElement("button");
      btnClear.className = "btn-small";
      btnClear.textContent = "é¸æŠè§£é™¤";
      btnClear.addEventListener("click", () => {
        selectedUnitIds = new Set();
        refreshUnitSelectionVisual();
      });

      const btnMulti = document.createElement("button");
      btnMulti.className = "btn-small";
      btnMulti.textContent = "è¤‡æ•°é¸æŠ:OFF";
      btnMulti.addEventListener("click", () => {
        multiSelectMode = !multiSelectMode;
        btnMulti.textContent = multiSelectMode ? "è¤‡æ•°é¸æŠ:ON" : "è¤‡æ•°é¸æŠ:OFF";
      });

      row1.appendChild(btnAll);
      row1.appendChild(btnClear);
      row1.appendChild(btnMulti);
      container.appendChild(row1);

      const row2 = document.createElement("div");
      row2.className = "unit-controls-row";

      const btnLv6 = document.createElement("button");
      btnLv6.className = "btn-small";
      btnLv6.textContent = "Lv6";
      btnLv6.addEventListener("click", () => applyLevelToSelection(6));

      const btnLv12 = document.createElement("button");
      btnLv12.className = "btn-small";
      btnLv12.textContent = "Lv12";
      btnLv12.addEventListener("click", () => applyLevelToSelection(12));

      const btnLv15 = document.createElement("button");
      btnLv15.className = "btn-small";
      btnLv15.textContent = "Lv15";
      btnLv15.addEventListener("click", () => applyLevelToSelection(15));

      const btnTreasure = document.createElement("button");
      btnTreasure.className = "btn-small";
      btnTreasure.textContent = "å°‚ç”¨ğŸ‘‘åˆ‡æ›¿";
      btnTreasure.addEventListener("click", () => toggleTreasureOnSelection());

      row2.appendChild(btnLv6);
      row2.appendChild(btnLv12);
      row2.appendChild(btnLv15);
      row2.appendChild(btnTreasure);

      const btnAwaken = document.createElement("button");
      btnAwaken.className = "btn-small";
      btnAwaken.textContent = "è¦šé†’/é€€åŒ–";
      btnAwaken.addEventListener("click", () => toggleFormAwakening());
      row2.appendChild(btnAwaken);

      container.appendChild(row2);

      const grid = document.createElement("div");
      grid.className = "unit-grid";

      MYTHIC_IDS.forEach(id => {
        const item = document.createElement("div");
        item.className = "unit-item dim";
        item.dataset.id = id;
        item.dataset.level = "0";
        item.dataset.treasure = "0";
        item.dataset.form = "mythic";

        const inner = document.createElement("div");
        inner.className = "unit-inner";

        const img = document.createElement("img");
        img.className = "unit-img";
        img.alt = id;
        img.src = ICON_BASE_PATH + id + ".png";

        const badge = document.createElement("div");
        badge.className = "unit-badge";
        badge.textContent = "Lv0";

    <script type="module" src="./ld_users_editor.js"></script>

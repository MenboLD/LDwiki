<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç·¨é›†ï¼ˆld_usersï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./ld_users_editor.css" />

</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="app-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</div>
        <div class="app-subtitle">ld_usersï¼ˆæ¤œç´¢ â†’ ç·¨é›† â†’ ä¿å­˜ï¼‰</div>
      </div>
      <div style="text-align: right;">
        <div id="headerStats" class="app-subtitle"></div>
        <button id="btnAdmin" class="btn-small" style="margin-top:4px;">ç®¡ç†è€…</button>
        <div id="adminStatus" class="app-subtitle"></div>
      </div>
    </header>

    <main>
      <!-- ãƒ›ãƒ¼ãƒ ãƒ“ãƒ¥ãƒ¼ï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‹æ¤œç´¢ -->
      <section id="homeView" class="card">
        <div class="card-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <div class="field">
          <button id="btnGoNew" class="btn-primary">ï¼‹ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</button>
        </div>
        <div class="card-title" style="margin-top:8px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</div>
        <div class="field">
          <div class="search-row">
            <input id="searchNameInput" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆéƒ¨åˆ†ä¸€è‡´å¯ï¼‰" />
            <button id="btnSearch" class="btn-small primary">æ¤œç´¢</button>
          </div>
        </div>
        <div id="searchResults" class="search-results"></div>
      </section>

      <!-- ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ¥ãƒ¼ -->
      <section id="formView" class="card hidden">
        <div id="formModeLabel" class="mode-label"></div>
        <div class="field">
          <label for="inputName">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
          <input id="inputName" type="text" autocomplete="off" />
        </div>
        <div class="field" id="fieldTag">
          <label for="inputTag">è­˜åˆ¥ç•ªå·ï¼ˆ2æ¡ï¼‰</label>
          <input id="inputTag" type="text" maxlength="2" autocomplete="off" />
        </div>
        <div class="field">
          <label for="selectVaultLevel">é‡‘åº«ãƒ¬ãƒ™ãƒ«</label>
          <select id="selectVaultLevel">
            <option value="1">Lv1</option>
            <option value="2">Lv2</option>
            <option value="3">Lv3</option>
            <option value="4">Lv4</option>
            <option value="5">Lv5</option>
            <option value="6">Lv6</option>
            <option value="7">Lv7</option>
            <option value="8">Lv8</option>
            <option value="9">Lv9</option>
            <option value="10">Lv10</option>
            <option value="11">Lv11</option>
          </select>
        </div>

        <div class="card-subtitle">ç¥è©±ãƒ¦ãƒ‹ãƒƒãƒˆï¼ˆ501ã€œ528ï¼‰</div>
        <div id="mythicGrid"></div>
        <div class="mythic-note">
          ãƒ»Lv6 / Lv12 / Lv15<br />
          ãƒ»Lv12ä»¥ä¸Šã§ğŸ‘‘ï¼ˆå°‚ç”¨ï¼‰ONå¯ï¼ˆç¥è©±ã®ã¿ï¼‰<br />
          ãƒ»ä¸æ»…åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã§ã€Œç¥è©± â‡„ ä¸æ»…ã€<br />
        </div>

        <div class="status-row">
          <span id="statusComments">ã‚³ãƒ¡æ•°: -</span>
          <span id="statusMisInputs">èª¤å…¥åŠ›: -</span>
          <span id="statusLikes">ã‚¤ã‚¤ã­: -</span>
        </div>

        <div class="btn-row" style="margin-top:8px;">
          <button id="btnBackHome" class="btn-secondary">æˆ»ã‚‹</button>
          <button id="btnSaveUser" class="btn-primary">ä¿å­˜</button>
        </div>
      </section>
    </main>

    <!-- ã‚¿ã‚°èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal">
        <div class="modal-title">è­˜åˆ¥ç•ªå·ã®ç¢ºèª</div>
        <div class="modal-body">
          ç·¨é›†ã™ã‚‹å‰ã«ã€2æ¡ã®è­˜åˆ¥ç•ªå·ã‚’ç¢ºèªã—ã¾ã™ã€‚
        </div>
        <div class="field">
          <label for="modalTagInput">è­˜åˆ¥ç•ªå·ï¼ˆ2æ¡ï¼‰</label>
          <input id="modalTagInput" type="text" maxlength="2" autocomplete="off" />
        </div>
        <div id="modalError" class="modal-body text-danger" style="display:none;"></div>
        <div class="modal-actions">
          <button id="btnModalCancel" class="btn-small">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="btnModalOk" class="btn-small primary">æ±ºå®š</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <script type="module">
    const SUPABASE_URL = "https://teggcuiyqkbcvbhdntni.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRlZ2djdWl5cWtiY3ZiaGRudG5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTIyNzUsImV4cCI6MjA4MDE2ODI3NX0.R1p_nZdmR9r4k0fNwgr9w4irkFwp-T8tGiEeJwJioKc"; // å…ƒã®v5ã¨åŒã˜ã‚‚ã®ã‚’å…¥ã‚Œã¦ãã ã•ã„

    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ADMIN_SECRET = "CHANGE_THIS_SECRET"; // åˆè¨€è‘‰ã€‚ä»»æ„ã®æ–‡å­—åˆ—ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

    const appState = {
      mode: "home",
      currentUser: null,
      usersCount: null,
      isAdmin: false,
    };

    const MYTHIC_IDS = [
      "501","502","503","504","505",
      "506","507","508","509","510",
      "511","512","513","514","515",
      "516","517","518","519","520",
      "521","522","523","524","525",
      "526","527","528"
    ];

    // ä¸æ»…ã¸ã®è¦šé†’ãŒå­˜åœ¨ã™ã‚‹ç¥è©±ID
    const AWAKENABLE_IDS = new Set([
      "501","502","504","506","509","511","513","514","515","516","525","526","527","528"
    ]);

    const ICON_BASE_PATH = "https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/";

    let mythicNames = {};

    async function loadMythicNames() {
      try {
        const { data, error } = await supabase
          .from("ld_units_master")
          .select("base_id, name_jp")
          .in("base_id", MYTHIC_IDS.map(id => parseInt(id, 10)));
        if (error) {
          console.error("ld_units_master èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", error);
          return;
        }
        data.forEach(row => {
          const key = String(row.base_id);
          if (!mythicNames[key]) {
            mythicNames[key] = row.name_jp;
          }
        });
      } catch (e) {
        console.error("ld_units_master èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼", e);
      }
    }

    function getUnitName(id) {
      return mythicNames[id] || id;
    }

    let multiSelectMode = false;
    let selectedUnitIds = new Set();

    function showToast(message, ms = 2000) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, ms);
    }

    function setView(mode) {
      appState.mode = mode;
      const homeView = document.getElementById("homeView");
      const formView = document.getElementById("formView");
      if (mode === "home") {
        homeView.classList.remove("hidden");
        formView.classList.add("hidden");
      } else {
        homeView.classList.add("hidden");
        formView.classList.remove("hidden");
      }
    }

    function formatStatsHeader() {
      const el = document.getElementById("headerStats");
      if (appState.usersCount == null) {
        el.textContent = "";
      } else {
        el.textContent = `ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${appState.usersCount}äºº`;
      }
    }

    async function fetchUsersCount() {
      const { count, error } = await supabase
        .from("ld_users")
        .select("*", { count: "exact", head: true });
      if (error) {
        console.error(error);
        return;
      }
      appState.usersCount = count ?? 0;
      formatStatsHeader();
    }

    const btnGoNew = document.getElementById("btnGoNew");
    const btnSearch = document.getElementById("btnSearch");
    const searchNameInput = document.getElementById("searchNameInput");
    const searchResults = document.getElementById("searchResults");
    const btnBackHome = document.getElementById("btnBackHome");
    const btnSaveUser = document.getElementById("btnSaveUser");
    const formModeLabel = document.getElementById("formModeLabel");
    const inputName = document.getElementById("inputName");
    const inputTag = document.getElementById("inputTag");
    const fieldTag = document.getElementById("fieldTag");
    const selectVaultLevel = document.getElementById("selectVaultLevel");
    const statusComments = document.getElementById("statusComments");
    const statusMisInputs = document.getElementById("statusMisInputs");
    const statusLikes = document.getElementById("statusLikes");
    const btnAdmin = document.getElementById("btnAdmin");
    const adminStatus = document.getElementById("adminStatus");

    const MAX_NAME_LENGTH = 7;
    inputName.setAttribute("maxlength", String(MAX_NAME_LENGTH));

    function updateAdminStatus() {
      adminStatus.textContent = appState.isAdmin ? "ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰" : "";
    }

    function renderSearchResults(list) {
      searchResults.innerHTML = "";
      if (!list || list.length === 0) {
        const div = document.createElement("div");
        div.textContent = "è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
        div.style.fontSize = "11px";
        div.style.color = "var(--text-sub)";
        searchResults.appendChild(div);
        return;
      }
      list.forEach((user) => {
        const item = document.createElement("div");
        item.className = "search-item";

        const main = document.createElement("div");
        main.className = "search-item-main";

        const nameLine = document.createElement("div");
        nameLine.className = "search-item-name";
        nameLine.textContent = user.name;

        const subLine = document.createElement("div");
        subLine.className = "search-item-sub";
        subLine.textContent = `è­˜åˆ¥ç•ªå·: ${user.tag} / é‡‘åº«Lv: ${user.vault_level ?? "-"}`;

        main.appendChild(nameLine);
        main.appendChild(subLine);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.flexDirection = "column";
        right.style.gap = "4px";
        right.style.alignItems = "flex-end";

        const badges = document.createElement("div");
        badges.style.display = "flex";
        badges.style.gap = "4px";
        badges.style.flexWrap = "wrap";

        const badgeComments = document.createElement("span");
        badgeComments.className = "badge";
        badgeComments.textContent = `ã‚³ãƒ¡: ${user.comment_count ?? 0}`;
        badges.appendChild(badgeComments);

        const badgeMis = document.createElement("span");
        badgeMis.className = user.mis_input_count > 0 ? "badge badge-danger" : "badge";
        badgeMis.textContent = `èª¤: ${user.mis_input_count ?? 0}`;
        badges.appendChild(badgeMis);

        const badgeLikes = document.createElement("span");
        badgeLikes.className = "badge badge-accent";
        badgeLikes.textContent = `ã‚¤ã‚¤ã­: ${user.like_count ?? 0}`;
        badges.appendChild(badgeLikes);

        right.appendChild(badges);

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn-small primary";
        btnEdit.textContent = "ç·¨é›†";

        btnEdit.addEventListener("click", () => {
          openTagConfirmModal(user);
        });

        right.appendChild(btnEdit);

        item.appendChild(main);
        item.appendChild(right);
        searchResults.appendChild(item);
      });
    }

    async function searchUsers() {
      const keyword = searchNameInput.value.trim();
      if (!keyword) {
        showToast("æ¤œç´¢ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const { data, error } = await supabase
        .from("ld_users")
        .select("id, name, tag, vault_level, comment_count, mis_input_count, like_count")
        .ilike("name", `%${keyword}%`)
        .order("name", { ascending: true })
        .limit(50);
      if (error) {
        console.error(error);
        showToast("ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        return;
   <script type="module" src="./ld_users_editor.js"></script>

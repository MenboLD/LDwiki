<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„É©„ÉÉ„Ç≠„ÉºÂÇ≠ÂÖµÂõ£ Áõ§Èù¢„Ç®„Éá„Ç£„ÇøÔºà„Éâ„É©„ÉÉ„Ç∞ÂØæÂøú„É¢„ÉÉ„ÇØ v2Ôºâ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #fafafa;
      --card-bg: #ffffff;
      --border: #dddddd;
      --text-main: #222222;
      --text-sub: #666666;
      --accent: #3874ff;
      --accent-soft: #e7f0ff;
      --danger: #d33;
      --grid-border: #cccccc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP",
        "Noto Sans", "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
    }
    .app {
      max-width: 420px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      background-color: var(--bg);
    }
    header.app-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      background-color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .app-title {
      font-size: 14px;
      font-weight: 600;
    }
    .unit-count-global {
      font-size: 11px;
      color: var(--text-sub);
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 6px;
      gap: 6px;
    }
    .board-toggle {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
    }
    .board-toggle button {
      flex: 1;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #ffffff;
      cursor: pointer;
    }
    .board-toggle button.active {
      background-color: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }
    .board-wrapper {
      background-color: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px;
    }
    .board-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .board {
      width: 100%;
      max-width: 380px;
      margin: 0 auto;
    }
    .grid-normal,
    .grid-special {
      display: none;
    }
    .grid-normal.active,
    .grid-special.active {
      display: grid;
    }
    .grid-normal {
      grid-template-columns: repeat(6, 1fr);
      grid-auto-rows: 40px;
      gap: 2px;
      margin-bottom: 4px;
    }
    .grid-special {
      grid-template-columns: repeat(6, 1fr);
      grid-auto-rows: 40px;
      gap: 2px;
      margin-bottom: 4px;
    }
    .cell {
      border: 1px solid var(--grid-border);
      border-radius: 4px;
      background-color: #fdfdfd;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-main);
      cursor: pointer;
      overflow: hidden;
    }
    .cell.empty {
      background-color: #f7f7f7;
      color: #bbbbbb;
      font-size: 9px;
    }
    .cell img.unit-img-basic {
      width: 30px;
      height: 30px;
      object-fit: contain;
      pointer-events: none;
    }
    .cell img.unit-img-special {
      width: 40px;
      height: 40px;
      object-fit: contain;
      pointer-events: none;
    }
    .cell .unit-count-badge {
      position: absolute;
      right: 2px;
      bottom: 1px;
      font-size: 10px;
      font-weight: 600;
      background: rgba(255,255,255,0.9);
      padding: 0 3px;
      border-radius: 999px;
      border: 1px solid #dddddd;
    }
    .label-row {
      grid-column: 1 / span 3;
      border: 1px dashed var(--grid-border);
      border-radius: 4px;
      background-color: #f3f3f3;
      font-size: 10px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    .trash-area {
      margin-top: 2px;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }
    .trash-left {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .trash-box {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #f8f8f8;
      padding: 2px 8px;
      font-size: 11px;
      min-width: 140px;
    }
    .trash-box.drag-over {
      border-color: var(--danger);
      background-color: #ffecec;
      color: var(--danger);
    }
    .palette-wrapper {
      background-color: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px;
    }
    .palette-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
    }
    .palette-tabs button {
      flex: 1;
      font-size: 11px;
      padding: 4px 0;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #ffffff;
      cursor: pointer;
    }
    .palette-tabs button.active {
      background-color: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }
    .palette-list {
      display: flex;
      gap: 4px;
      overflow-x: auto;
      padding-bottom: 2px;
    }
    .palette-item {
      min-width: 40px;
      height: 40px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: #f7f7ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      cursor: grab;
      overflow: hidden;
    }
    .palette-item img.unit-img-basic,
    .palette-item img.unit-img-special {
      pointer-events: none;
    }
    .inspector-wrapper {
      background-color: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px;
      font-size: 11px;
      min-height: 56px;
    }
    .inspector-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
    }
    .inspector-body {
      font-size: 11px;
      color: var(--text-sub);
    }
    .inspector-actions {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .btn-small {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #ffffff;
      cursor: pointer;
    }
    .btn-small.primary {
      border-color: var(--accent);
      background-color: var(--accent-soft);
      color: var(--accent);
    }
  
    /* Palette expanded header & toggle */
    .palette-wrapper {
      position: relative;
    }
    .palette-header {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
    }
    .palette-tabs-normal {
      flex: 1;
    }
    .palette-tabs-expanded {
      flex: 1;
    }
    .palette-toggle {
      width: 32px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #ffffff;
      font-size: 12px;
      cursor: pointer;
    }
    .palette-list-wrapper {
      overflow: hidden;
    }
    .palette-wrapper.expanded .palette-list {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      max-height: 170px; /* Á¥Ñ2.5Ë°åÂàÜ */
      overflow-y: auto;
      overflow-x: hidden;
    }
    .palette-wrapper.expanded .palette-tabs-normal {
      display: none;
    }
    .palette-wrapper.expanded .palette-tabs-expanded {
      display: flex !important;
    }
    .palette-wrapper:not(.expanded) .palette-tabs-expanded {
      display: none !important;
    }
    .palette-wrapper:not(.expanded) .palette-tabs-normal {
      display: flex;
    }
    /* „Éë„É¨„ÉÉ„ÉàÂÜÖ„ÅÆÁîªÂÉè„Çµ„Ç§„Ç∫Êã°Â§ß */
    .palette-item {
      min-width: 60px;
      height: 60px;
    }
    .palette-item img.unit-img-basic {
      width: 46px;
      height: 46px;
    }
    .palette-item img.unit-img-special {
      width: 60px;
      height: 60px;
    }
    /* ÈÅ∏Êäû‰∏≠„ÅÆ„Éû„Çπ„Éª„Éë„É¨„ÉÉ„Éà„ÅÆËµ§Êû† */
    .cell.selected {
      outline: 2px solid #ff4a4a;
      outline-offset: -2px;
    }
    .palette-item.selected {
      border-color: #ff4a4a;
      box-shadow: 0 0 0 1px #ff4a4a;
    }
    /* Ê∫ÄÂì°„Éú„Çø„É≥„ÅÆ„Ç∑„Çß„Ç§„ÇØÊºîÂá∫ */
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      50% { transform: translateX(2px); }
      75% { transform: translateX(-2px); }
      100% { transform: translateX(0); }
    }
    .shake {
      animation: shake 0.25s;
    }
    /* „Çª„É´Âë®Ëæ∫„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éú„Çø„É≥ */
    .cell-action-layer {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 50;
      pointer-events: none;
    }
    .cell-action-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      pointer-events: none;
    }
    .cell-action-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      padding: 2px;
      pointer-events: none;
    }
    .cell-action-row button {
      pointer-events: auto;
      flex: 1;
    }
    .cell-action-row.double button {
      flex: initial;
      min-width: 80px;
    }
    /* „Çπ„Éû„ÉõÂêë„ÅëÔºöÈï∑Êäº„Åó„ÅÆË™§Êìç‰ΩúÂØæÁ≠ñ */
    body {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    img {
      -webkit-user-drag: none;
    }

  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">Áõ§Èù¢„Ç®„Éá„Ç£„ÇøÔºà„Éâ„É©„ÉÉ„Ç∞ÂØæÂøú„É¢„ÉÉ„ÇØ v2Ôºâ</div>
      <div id="unitCountLabel" class="unit-count-global">„É¶„Éã„ÉÉ„ÉàÊï∞: 0 / 30</div>
    </header>

    <main>
      <!-- Áõ§Èù¢ -->
      <section class="board-wrapper">
        <div class="board-label">
          <span>Áõ§Èù¢</span>
          <div class="board-toggle">
            <button id="btnNormal" class="active">ÈÄöÂ∏∏Áõ§Èù¢</button>
            <button id="btnSpecial">ÁâπÊÆäÁõ§Èù¢</button>
          </div>
        </div>

        <div class="board">
          <!-- ÈÄöÂ∏∏Áõ§Èù¢ -->
          <div id="gridNormal" class="grid-normal active">
            <div class="cell empty" data-x="0" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="label-row">
              <span>„ÉÄ„É≥„Ç∏„Éß„É≥„ÇÑÁ•û„ÅÆÁ•†Áî®‚Üí</span>
            </div>
            <div class="cell empty" data-x="3" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
          </div>

          <!-- ÁâπÊÆäÁõ§Èù¢Ôºà5Ë°å√ó6ÂàóÔºâ -->
          <div id="gridSpecial" class="grid-special">
            <div class="cell empty" data-x="0" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>

          </div>
        </div>

        <div class="trash-area">
          <div class="trash-left">
            <span>üóë</span>
            <span id="trashBox" class="trash-box">„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞„ÅßÂâäÈô§</span>
          </div>
          <button id="btnClearAll" class="btn-small">ÂÖ®„ÇØ„É™„Ç¢</button>
        </div>
      </section>
      <div id="cellActionLayer" class="cell-action-layer"></div>



      <!-- „Éë„É¨„ÉÉ„Éà -->
      
      <!-- „Éë„É¨„ÉÉ„Éà -->
      <section class="palette-wrapper">
        <div class="palette-header">
          <div class="palette-tabs palette-tabs-normal">
            <button class="active" data-group="N">N</button>
            <button data-group="R">R</button>
            <button data-group="E">E</button>
            <button data-group="L">L</button>
            <button data-group="M">Á•û</button>
            <button data-group="I">‰∏ç</button>
            <button data-group="EX">EX</button>
          </div>
          <div class="palette-tabs palette-tabs-expanded" style="display:none;">
            <button class="active" data-group="BASIC">Âü∫Êú¨„É¶„Éã„ÉÉ„Éà</button>
            <button data-group="M">Á•ûË©±</button>
            <button data-group="I">‰∏çÊªÖ</button>
            <button data-group="EX">EX</button>
          </div>
          <button id="paletteToggle" class="palette-toggle">‚ñº</button>
        </div>
        <div class="palette-list-wrapper">
          <div class="palette-list">
          <div class="palette-item" draggable="true" data-code="101" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/101_big.png" alt="101" />
          </div>
          <div class="palette-item" draggable="true" data-code="102" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/102_big.png" alt="102" />
          </div>
          <div class="palette-item" draggable="true" data-code="103" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/103_big.png" alt="103" />
          </div>
          <div class="palette-item" draggable="true" data-code="104" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/104_big.png" alt="104" />
          </div>
          <div class="palette-item" draggable="true" data-code="105" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/105_big.png" alt="105" />
          </div>
          <div class="palette-item" draggable="true" data-code="106" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/106_big.png" alt="106" />
          </div>
          <div class="palette-item" draggable="true" data-code="201" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/201_big.png" alt="201" />
          </div>
          <div class="palette-item" draggable="true" data-code="202" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/202_big.png" alt="202" />
          </div>
          <div class="palette-item" draggable="true" data-code="203" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/203_big.png" alt="203" />
          </div>
          <div class="palette-item" draggable="true" data-code="204" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/204_big.png" alt="204" />
          </div>
          <div class="palette-item" draggable="true" data-code="205" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/205_big.png" alt="205" />
          </div>
          <div class="palette-item" draggable="true" data-code="301" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/301_big.png" alt="301" />
          </div>
          <div class="palette-item" draggable="true" data-code="302" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/302_big.png" alt="302" />
          </div>
          <div class="palette-item" draggable="true" data-code="303" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/303_big.png" alt="303" />
          </div>
          <div class="palette-item" draggable="true" data-code="304" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/304_big.png" alt="304" />
          </div>
          <div class="palette-item" draggable="true" data-code="305" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/305_big.png" alt="305" />
          </div>
          <div class="palette-item" draggable="true" data-code="401" data-group="L">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/401_big.png" alt="401" />
          </div>
          <div class="palette-item" draggable="true" data-code="402" data-group="L">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/402_big.png" alt="402" />
          </div>
          <div class="palette-item" draggable="true" data-code="403" data-group="L">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/403_big.png" alt="403" />
          </div>
          <div class="palette-item" draggable="true" data-code="404" data-group="L">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/404_big.png" alt="404" />
          </div>
          <div class="palette-item" draggable="true" data-code="501" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/501_big.png" alt="501" />
          </div>
          <div class="palette-item" draggable="true" data-code="502" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/502_big.png" alt="502" />
          </div>
          <div class="palette-item" draggable="true" data-code="503" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/503_big.png" alt="503" />
          </div>
          <div class="palette-item" draggable="true" data-code="504" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/504_big.png" alt="504" />
          </div>
          <div class="palette-item" draggable="true" data-code="505" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/505_big.png" alt="505" />
          </div>
          <div class="palette-item" draggable="true" data-code="506" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/506_big.png" alt="506" />
          </div>
          <div class="palette-item" draggable="true" data-code="507" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/507_big.png" alt="507" />
          </div>
          <div class="palette-item" draggable="true" data-code="508" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/508_big.png" alt="508" />
          </div>
          <div class="palette-item" draggable="true" data-code="509" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/509_big.png" alt="509" />
          </div>
          <div class="palette-item" draggable="true" data-code="510" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/510_big.png" alt="510" />
          </div>
          <div class="palette-item" draggable="true" data-code="511" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/511_big.png" alt="511" />
          </div>
          <div class="palette-item" draggable="true" data-code="512" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/512_big.png" alt="512" />
          </div>
          <div class="palette-item" draggable="true" data-code="513" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/513_big.png" alt="513" />
          </div>
          <div class="palette-item" draggable="true" data-code="514" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/514_big.png" alt="514" />
          </div>
          <div class="palette-item" draggable="true" data-code="515" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/515_big.png" alt="515" />
          </div>
          <div class="palette-item" draggable="true" data-code="516" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/516_big.png" alt="516" />
          </div>
          <div class="palette-item" draggable="true" data-code="517" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/517_big.png" alt="517" />
          </div>
          <div class="palette-item" draggable="true" data-code="518" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/518_big.png" alt="518" />
          </div>
          <div class="palette-item" draggable="true" data-code="519" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/519_big.png" alt="519" />
          </div>
          <div class="palette-item" draggable="true" data-code="520" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/520_big.png" alt="520" />
          </div>
          <div class="palette-item" draggable="true" data-code="521" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/521_big.png" alt="521" />
          </div>
          <div class="palette-item" draggable="true" data-code="522" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/522_big.png" alt="522" />
          </div>
          <div class="palette-item" draggable="true" data-code="523" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/523_big.png" alt="523" />
          </div>
          <div class="palette-item" draggable="true" data-code="524" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/524_big.png" alt="524" />
          </div>
          <div class="palette-item" draggable="true" data-code="525" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/525_big.png" alt="525" />
          </div>
          <div class="palette-item" draggable="true" data-code="526" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/526_big.png" alt="526" />
          </div>
          <div class="palette-item" draggable="true" data-code="527" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/527_big.png" alt="527" />
          </div>
          <div class="palette-item" draggable="true" data-code="528" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/528_big.png" alt="528" />
          </div>
          <div class="palette-item" draggable="true" data-code="601" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/601_big.png" alt="601" />
          </div>
          <div class="palette-item" draggable="true" data-code="602" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/602_big.png" alt="602" />
          </div>
          <div class="palette-item" draggable="true" data-code="604" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/604_big.png" alt="604" />
          </div>
          <div class="palette-item" draggable="true" data-code="606" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/606_big.png" alt="606" />
          </div>
          <div class="palette-item" draggable="true" data-code="609" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/609_big.png" alt="609" />
          </div>
          <div class="palette-item" draggable="true" data-code="611" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/611_big.png" alt="611" />
          </div>
          <div class="palette-item" draggable="true" data-code="613" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/613_big.png" alt="613" />
          </div>
          <div class="palette-item" draggable="true" data-code="614" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/614_big.png" alt="614" />
          </div>
          <div class="palette-item" draggable="true" data-code="615a" data-group="I">
            <img class="unit-img-special" src="unit_imgs/615_a.png" alt="615a" />
          </div>
          <div class="palette-item" draggable="true" data-code="615b" data-group="I">
            <img class="unit-img-special" src="unit_imgs/615_b.png" alt="615b" />
          </div>
          <div class="palette-item" draggable="true" data-code="616" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/616_big.png" alt="616" />
          </div>
          <div class="palette-item" draggable="true" data-code="625" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/625_big.png" alt="625" />
          </div>
          <div class="palette-item" draggable="true" data-code="626" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/626_big.png" alt="626" />
          </div>
          <div class="palette-item" draggable="true" data-code="627" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/627_big.png" alt="627" />
          </div>
          <div class="palette-item" draggable="true" data-code="628" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/628_big.png" alt="628" />
          </div>
          <div class="palette-item" draggable="true" data-code="709" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/709_big.png" alt="709" />
          </div>
          <div class="palette-item" draggable="true" data-code="710" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/710_big.png" alt="710" />
          </div>
          <div class="palette-item" draggable="true" data-code="711" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/711_big.png" alt="711" />
          </div>
          <div class="palette-item" draggable="true" data-code="712" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/712_big.png" alt="712" />
          </div>
          <div class="palette-item" draggable="true" data-code="713" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/713_big.png" alt="713" />
          </div>
          <div class="palette-item" draggable="true" data-code="714" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/714_big.png" alt="714" />
          </div>
          <div class="palette-item" draggable="true" data-code="715" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/715_big.png" alt="715" />
          </div>
          <div class="palette-item" draggable="true" data-code="720" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/720_big.png" alt="720" />
          </div>
        
          </div>
        </div>
      </section>



      <!-- „Ç§„É≥„Çπ„Éö„ÇØ„Çø -->
      <section class="inspector-wrapper">
        <div class="inspector-title">„Éû„Çπ„ÅÆÊÉÖÂ†±</div>
        <div id="inspectorBody" class="inspector-body">
          „Éû„Çπ„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Êìç‰Ωú„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
        </div>
        <div id="inspectorActions" class="inspector-actions"></div>
      </section>
    </main>
  </div>

  <script>

    const ICON_BASE = "https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/";
    const ICON_BIG_BASE = ICON_BASE;
    let currentPaletteCode = null;
    function parseCodeNumber(code) {
      if (!code) return NaN;
      const m = String(code).match(/\d+/);
      return m ? parseInt(m[0], 10) : NaN;
    }

    function getActiveGrid() {
      const normal = document.getElementById('gridNormal');
      const special = document.getElementById('gridSpecial');
      if (normal.classList.contains('active')) return normal;
      return special;
    }

    function getBoardUnitCount() {
      const grid = getActiveGrid();
      let total = 0;
      grid.querySelectorAll('.cell').forEach(cell => {
        if (cell.classList.contains('label-row')) return;
        const code = cell.dataset.code;
        if (!code) return;
        const count = parseInt(cell.dataset.count || '0', 10);
        const n = parseCodeNumber(code);
        if (n >= 100 && n < 500) {
          total += count;
        } else {
          total += 1;
        }
      });
      return total;
    }

    function recalcUnitCount() {
      const total = getBoardUnitCount();
      document.getElementById('unitCountLabel').textContent =
        '„É¶„Éã„ÉÉ„ÉàÊï∞: ' + total + ' / 30';
    }

    function makeEmptyCell(cell) {
      cell.dataset.code = '';
      cell.dataset.kind = '';
      cell.dataset.count = '0';
      cell.classList.add('empty');
      cell.removeAttribute('draggable');
      cell.innerHTML = 'Á©∫';
    }

    function clearActiveBoard() {
      const grid = getActiveGrid();
      grid.querySelectorAll('.cell').forEach(cell => {
        if (cell.classList.contains('label-row')) return;
        makeEmptyCell(cell);
      });
      recalcUnitCount();
      const inspectorBody = document.getElementById('inspectorBody');
      const inspectorActions = document.getElementById('inspectorActions');
      if (inspectorBody) {
        inspectorBody.textContent = '„Éû„Çπ„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Êìç‰Ωú„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ';
      }
      if (inspectorActions) {
        inspectorActions.innerHTML = '';
      }
    }

    function isBasicCode(code) {
      const n = parseCodeNumber(code);
      return n >= 100 && n < 500;
    }

    
    function getKindFromCode(code) {
      const n = parseCodeNumber(code);
      const mythicAwakable = [501, 502, 504, 506, 509, 511, 513, 514, 515, 516, 525, 526, 527, 528];
      if (mythicAwakable.indexOf(n) !== -1) return 'mythic-awakable';
      if (code === '615a' || code === '615b') return 'immortal-variant';
      if (n >= 100 && n < 500) return 'basic';
      if (n >= 500 && n < 600) return 'mythic';
      if (n >= 600 && n < 700) return 'immortal';
      return 'extra';
    }
}

    
    function renderCellContent(cell) {
      const code = cell.dataset.code;
      const count = parseInt(cell.dataset.count || '0', 10);

      if (!code) {
        makeEmptyCell(cell);
        return;
      }

      cell.classList.remove('empty');
      cell.setAttribute('draggable', 'true');

      const n = parseCodeNumber(code);
      const isBasic = n >= 100 && n < 500;
      const imgClass = isBasic ? 'unit-img-basic' : 'unit-img-special';

      let src = "";
      if (code === '615a') {
        src = ICON_BASE + '615_a.png';
      } else if (code === '615b') {
        src = ICON_BASE + '615_b.png';
      } else {
        src = ICON_BASE + (parseCodeNumber(code)) + '.png';
      }

      // ËÉåÊôØËâ≤Ôºà„É¨„Ç¢„É™„ÉÜ„Ç£ / Á®ÆÂà•„Åî„Å®Ôºâ
      cell.style.backgroundColor = '#f7f7f7';
      if (isBasic) {
        if (n >= 100 && n < 200) {
          cell.style.backgroundColor = '#AFA68C'; // N
        } else if (n >= 200 && n < 300) {
          cell.style.backgroundColor = '#3F4C82'; // R
        } else if (n >= 300 && n < 400) {
          cell.style.backgroundColor = '#683A8E'; // E
        } else if (n >= 400 && n < 500) {
          cell.style.backgroundColor = '#D2A349'; // L
        }
      } else {
        const k = cell.dataset.kind || getKindFromCode(code);
        if (k === 'mythic' || k === 'mythic-awakable') {
          cell.style.backgroundColor = '#C58540';
        } else if (k === 'immortal' || k === 'immortal-variant') {
          cell.style.backgroundColor = '#AF453A';
        } else if (k === 'extra') {
          cell.style.backgroundColor = '#ADB34D';
        }
      }

      let html = '<img class="' + imgClass + '" src="' + src + '" alt="' + code + '" />';
      if (isBasic) {
        html += '<span class="unit-count-badge">' + count + '</span>';
      }
      cell.innerHTML = html;
    }
}

    function findCell(x, y, root) {
      const selector = '.cell[data-x="' + x + '"][data-y="' + y + '"]';
      return (root || document).querySelector(selector);
    }

    
    function hideCellActionLayer() {
      const layer = document.getElementById('cellActionLayer');
      if (!layer) return;
      layer.innerHTML = '';
      layer.style.display = 'none';
    }

    function buildCellActionButtons(cell, kind, code, count) {
      const layer = document.getElementById('cellActionLayer');
      const app = document.querySelector('.app');
      if (!layer || !app) return;

      layer.innerHTML = '';
      if (!code) {
        hideCellActionLayer();
        return;
      }

      const cellRect = cell.getBoundingClientRect();
      const appRect = app.getBoundingClientRect();

      layer.style.display = 'block';
      layer.style.top = (cellRect.top - appRect.top + window.scrollY - 4) + 'px';
      layer.style.left = (cellRect.left - appRect.left + window.scrollX - 4) + 'px';
      layer.style.width = (cellRect.width + 8) + 'px';
      layer.style.height = (cellRect.height + 8) + 'px';

      const container = document.createElement('div');
      container.className = 'cell-action-container';

      if (kind === 'basic') {
        const row = document.createElement('div');
        row.className = 'cell-action-row';

        const btnMinus = document.createElement('button');
        btnMinus.className = 'btn-small';
        btnMinus.textContent = (count <= 1) ? 'ÂâäÈô§' : '‚àí';
        btnMinus.addEventListener('click', () => {
          let c = parseInt(cell.dataset.count || '0', 10);
          const codeNow = cell.dataset.code;

          // 3‰Ωì‚Üí2‰Ωì„Å´Ê∏õ„Çâ„Åô„Å®„Åç„ÄÅÂêåÁ®Æ„É¶„Éã„ÉÉ„Éà„ÅåÂà•„Éû„Çπ„Å´Â≠òÂú®„Åô„Çã„Å™„ÇâÁ¶ÅÊ≠¢
          if (c === 3) {
            const grid = getActiveGrid();
            let hasOther = false;
            grid.querySelectorAll('.cell').forEach(other => {
              if (other === cell) return;
              if (other.classList.contains('label-row')) return;
              if (other.dataset.code !== codeNow) return;
              const oc = parseInt(other.dataset.count || '0', 10);
              if (oc > 0) {
                hasOther = true;
              }
            });
            if (hasOther) {
              return;
            }
          }

          if (c > 1) {
            c -= 1;
            cell.dataset.count = String(c);
          } else {
            makeEmptyCell(cell);
          }
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });

        const btnPlus = document.createElement('button');
        btnPlus.className = 'btn-small';
        const totalNow = getBoardUnitCount();
        if (totalNow >= 30 && count < 3) {
          btnPlus.textContent = 'Ê∫ÄÂì°';
        } else {
          btnPlus.textContent = '+';
        }
        btnPlus.addEventListener('click', () => {
          let c = parseInt(cell.dataset.count || '0', 10);
          const totalCurrent = getBoardUnitCount();
          if (c >= 3) return;
          if (totalCurrent >= 30) {
            btnPlus.textContent = 'Ê∫ÄÂì°';
            btnPlus.classList.remove('shake');
            void btnPlus.offsetWidth;
            btnPlus.classList.add('shake');
            return;
          }
          c += 1;
          cell.dataset.count = String(c);
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });

        row.appendChild(btnMinus);
        row.appendChild(btnPlus);
        container.appendChild(row);

      } else if (kind === 'mythic-awakable' && code === '515') {
        const row = document.createElement('div');
        row.className = 'cell-action-row double';

        const btnAwBatter = document.createElement('button');
        btnAwBatter.textContent = 'Ë¶öÈÜí(ÊâìËÄÖ)';
        btnAwBatter.className = 'btn-small primary';
        btnAwBatter.addEventListener('click', () => {
          if (hasOtherImmortalVariant(cell)) return;
          cell.dataset.code = '615a';
          cell.dataset.kind = 'immortal-variant';
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });

        const btnAwPitcher = document.createElement('button');
        btnAwPitcher.textContent = 'Ë¶öÈÜí(ÊäïÊâã)';
        btnAwPitcher.className = 'btn-small primary';
        btnAwPitcher.addEventListener('click', () => {
          if (hasOtherImmortalVariant(cell)) return;
          cell.dataset.code = '615b';
          cell.dataset.kind = 'immortal-variant';
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });

        row.appendChild(btnAwBatter);
        row.appendChild(btnAwPitcher);
        container.appendChild(row);

      } else if (kind === 'mythic-awakable') {
        const row = document.createElement('div');
        row.className = 'cell-action-row';

        const btnAw = document.createElement('button');
        btnAw.textContent = 'Ë¶öÈÜí';
        btnAw.className = 'btn-small primary';
        btnAw.addEventListener('click', () => {
          const n = parseCodeNumber(code);
          const immortalCode = String(n + 100);
          if (!canAddNewUnit()) return;
          cell.dataset.code = immortalCode;
          cell.dataset.kind = getKindFromCode(immortalCode);
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });

        row.appendChild(btnAw);
        container.appendChild(row);

      } else if (kind === 'immortal-variant') {
        const row = document.createElement('div');
        row.className = 'cell-action-row';

        const btnDev = document.createElement('button');
        btnDev.textContent = 'ÈÄÄÂåñ';
        btnDev.className = 'btn-small';
        btnDev.addEventListener('click', () => {
          cell.dataset.code = '515';
          cell.dataset.kind = 'mythic-awakable';
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });

        row.appendChild(btnDev);
        container.appendChild(row);

      } else if (kind === 'immortal') {
        const row = document.createElement('div');
        row.className = 'cell-action-row';

        const btnDev = document.createElement('button');
        btnDev.textContent = 'ÈÄÄÂåñ';
        btnDev.className = 'btn-small';
        btnDev.addEventListener('click', () => {
          const n = parseCodeNumber(code);
          const mythicCode = String(n - 100);
          cell.dataset.code = mythicCode;
          cell.dataset.kind = getKindFromCode(mythicCode);
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });

        row.appendChild(btnDev);
        container.appendChild(row);
      }

      if (container.children.length === 0) {
        hideCellActionLayer();
      } else {
        layer.appendChild(container);
      }
    }

    function updateInspectorFromCell(cell) {
      const inspectorBody = document.getElementById('inspectorBody');
      const inspectorActions = document.getElementById('inspectorActions');
      inspectorActions.innerHTML = '';

      const code = cell.dataset.code;
      const kind = cell.dataset.kind || '';
      const count = parseInt(cell.dataset.count || '0', 10);

      if (!code) {
        inspectorBody.textContent = 'Á©∫„ÅÆ„Éû„Çπ„Åß„Åô„ÄÇ';
        hideCellActionLayer();
        return;
      }

      if (kind === 'basic') {
        inspectorBody.textContent = code + 'ÔºàÂü∫Êú¨„É¶„Éã„ÉÉ„ÉàÔºâ: ' + count + '‰Ωì';
      } else if (kind === 'mythic-awakable' && code === '515') {
        inspectorBody.textContent = code + 'ÔºàÁ•ûË©±ÔºâÔºöË¶öÈÜíÂÖà„ÇíÈÅ∏„Åπ„Åæ„Åô';
      } else if (kind === 'mythic-awakable') {
        inspectorBody.textContent = code + 'ÔºàÁ•ûË©±ÔºâÔºöË¶öÈÜí„Åß‰∏çÊªÖ„Å´„Åß„Åç„Åæ„Åô';
      } else if (kind === 'immortal-variant') {
        inspectorBody.textContent = code + 'Ôºà‰∏çÊªÖÔºâÔºöÈÄÄÂåñ„ÅßÁ•ûË©±„Å´Êàª„Åõ„Åæ„Åô';
      } else if (kind === 'immortal') {
        inspectorBody.textContent = code + 'Ôºà‰∏çÊªÖÔºâÔºöÈÄÄÂåñ„ÅßÁ•ûË©±„Å´Êàª„Åõ„Åæ„Åô';
      } else {
        inspectorBody.textContent = code + 'ÔºàÁâπÊÆä„É¶„Éã„ÉÉ„ÉàÔºâ: ÁâπÂà•„Å™Êìç‰Ωú„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì';
      }

      buildCellActionButtons(cell, kind, code, count);
    }
}

    function canPlaceBasicIntoNewCell(code) {
      const grid = getActiveGrid();
      let has1or2 = false;
      grid.querySelectorAll('.cell').forEach(cell => {
        if (cell.classList.contains('label-row')) return;
        if (cell.dataset.code !== code) return;
        const c = parseInt(cell.dataset.count || '0', 10);
        if (c === 1 || c === 2) {
          has1or2 = true;
        }
      });
      if (has1or2) return false;

      const total = getBoardUnitCount();
      if (total >= 30) return false;

      return true;
    }

    function canAddNewUnit() {
      const total = getBoardUnitCount();
      return total < 30;
    }

    function hasOtherImmortalVariant(targetCell) {
      const grid = getActiveGrid();
      let blocked = false;
      grid.querySelectorAll('.cell').forEach(other => {
        if (other === targetCell) return;
        if (other.classList.contains('label-row')) return;
        const oc = other.dataset.code;
        if (oc === '615a' || oc === '615b') {
          blocked = true;
        }
      });
      return blocked;
    }

    
    function attachCellHandlers(root) {
      const cells = root.querySelectorAll('.cell');
      cells.forEach(cell => {
        if (cell.classList.contains('label-row')) return;

        cell.addEventListener('click', () => {
          if (cell.classList.contains('label-row')) return;

          // „Çª„É´ÈÅ∏Êäû„ÅÆËµ§Êû†
          document.querySelectorAll('.cell.selected').forEach(c => c.classList.remove('selected'));
          cell.classList.add('selected');

          // „Éë„É¨„ÉÉ„Éà„Åã„Çâ„ÅÆ„Çø„ÉÉ„ÉóÈÖçÁΩÆ
          if (currentPaletteCode) {
            const code = currentPaletteCode;
            const n = parseCodeNumber(code);
            const isBasic = n >= 100 && n < 500;

            // 615a/615b „ÅØÁõ§Èù¢„Å´ÂêåÊôÇÂÖ±Â≠ò‰∏çÂèØ
            if (code === '615a' || code === '615b') {
              if (hasOtherImmortalVariant(cell)) {
                updateInspectorFromCell(cell);
                return;
              }
            }

            const currentCode = cell.dataset.code;
            const currentCount = parseInt(cell.dataset.count || '0', 10);

            if (!currentCode) {
              // Á©∫„Éû„Çπ„Å´Êñ∞Ë¶èÈÖçÁΩÆ
              if (isBasic) {
                if (!canPlaceBasicIntoNewCell(code)) {
                  updateInspectorFromCell(cell);
                  return;
                }
                cell.dataset.code = code;
                cell.dataset.kind = getKindFromCode(code);
                cell.dataset.count = '1';
                renderCellContent(cell);
              } else {
                if (!canAddNewUnit()) {
                  updateInspectorFromCell(cell);
                  return;
                }
                cell.dataset.code = code;
                cell.dataset.kind = getKindFromCode(code);
                cell.dataset.count = '1';
                renderCellContent(cell);
              }
            } else if (currentCode === code && isBasic) {
              // Âêå„ÅòÂü∫Êú¨„É¶„Éã„ÉÉ„Éà„Å™„Çâ„Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„ÉóÔºàÊúÄÂ§ß3„ÉªÁ∑èÊï∞30„Åæ„ÅßÔºâ
              let c = currentCount;
              if (c < 3) {
                const total = getBoardUnitCount();
                if (total >= 30) {
                  // Ê∫ÄÂì°ÊºîÂá∫„ÅØ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÂÅ¥„Å´‰ªª„Åõ„Çã
                } else {
                  c += 1;
                  cell.dataset.count = String(c);
                  renderCellContent(cell);
                }
              }
            } else {
              // Âà•„É¶„Éã„ÉÉ„Éà„Çí‰∏äÊõ∏„Åç
              if (!isBasic && !canAddNewUnit()) {
                updateInspectorFromCell(cell);
                return;
              }
              if (!isBasic || (isBasic && canPlaceBasicIntoNewCell(code))) {
                cell.dataset.code = code;
                cell.dataset.kind = getKindFromCode(code);
                cell.dataset.count = '1';
                renderCellContent(cell);
              }
            }

            recalcUnitCount();
            updateInspectorFromCell(cell);
            return;
          }

          // ÈÄöÂ∏∏„ÅÆÊÉÖÂ†±Êõ¥Êñ∞
          updateInspectorFromCell(cell);
        });

        cell.addEventListener('dragover', (e) => {
          e.preventDefault();
        });

        cell.addEventListener('drop', (e) => {
          e.preventDefault();
          const raw = e.dataTransfer.getData('text/plain') || '';
          if (!raw) return;
          let data;
          try { data = JSON.parse(raw); } catch { return; }
          const target = cell;
          if (target.classList.contains('label-row')) return;

          if (data.source === 'palette') {
            const code = data.code;
            const n = parseCodeNumber(code);
            const isBasic = n >= 100 && n < 500;

            // 615a/615b „ÅØÁõ§Èù¢„Å´ÂêåÊôÇÂÖ±Â≠ò‰∏çÂèØ
            if (code === '615a' || code === '615b') {
              if (hasOtherImmortalVariant(target)) {
                return;
              }
            }

            const currentCode = target.dataset.code;
            const currentCount = parseInt(target.dataset.count || '0', 10);

            if (!currentCode) {
              if (isBasic) {
                if (!canPlaceBasicIntoNewCell(code)) {
                  return;
                }
                target.dataset.code = code;
                target.dataset.kind = getKindFromCode(code);
                target.dataset.count = '1';
                renderCellContent(target);
              } else {
                if (!canAddNewUnit()) {
                  return;
                }
                target.dataset.code = code;
                target.dataset.kind = getKindFromCode(code);
                target.dataset.count = '1';
                renderCellContent(target);
              }
            } else if (currentCode === code && isBasic) {
              let c = currentCount;
              if (c < 3) {
                const total = getBoardUnitCount();
                if (total >= 30) return;
                c += 1;
                target.dataset.count = String(c);
                renderCellContent(target);
              }
            } else {
              if (!isBasic && !canAddNewUnit()) {
                return;
              }
              if (!isBasic || (isBasic && canPlaceBasicIntoNewCell(code))) {
                target.dataset.code = code;
                target.dataset.kind = getKindFromCode(code);
                target.dataset.count = '1';
                renderCellContent(target);
              }
            }

            recalcUnitCount();
            updateInspectorFromCell(target);

          } else if (data.source === 'cell') {
            const src = findCell(data.x, data.y, document);
            if (!src || src === target) return;
            if (src.classList.contains('label-row')) return;

            const srcCode = src.dataset.code;
            const srcCount = src.dataset.count;
            const srcKind = src.dataset.kind;

            const tgtCode = target.dataset.code;
            const tgtCount = target.dataset.count;
            const tgtKind = target.dataset.kind;

            src.dataset.code = tgtCode || '';
            src.dataset.count = tgtCount || '0';
            src.dataset.kind = tgtKind || '';

            target.dataset.code = srcCode || '';
            target.dataset.count = srcCount || '0';
            target.dataset.kind = srcKind || '';

            if (src.dataset.code) src.setAttribute('draggable', 'true');
            else src.removeAttribute('draggable');
            if (target.dataset.code) target.setAttribute('draggable', 'true');
            else target.removeAttribute('draggable');

            renderCellContent(src);
            renderCellContent(target);

            recalcUnitCount();
          }
        });
      });
    }
}

    function attachCellDragStart() {
      document.querySelectorAll('#gridNormal .cell, #gridSpecial .cell').forEach(cell => {
        if (cell.classList.contains('label-row')) return;
        cell.addEventListener('dragstart', (e) => {
          if (!cell.dataset.code) {
            e.preventDefault();
            return;
          }
          const payload = { source: 'cell', x: cell.dataset.x, y: cell.dataset.y };
          e.dataTransfer.setData('text/plain', JSON.stringify(payload));
        });
      });
    }

    const btnNormal = document.getElementById('btnNormal');
    const btnSpecial = document.getElementById('btnSpecial');
    const gridNormal = document.getElementById('gridNormal');
    const gridSpecial = document.getElementById('gridSpecial');

    btnNormal.addEventListener('click', () => {
      btnNormal.classList.add('active');
      btnSpecial.classList.remove('active');
      gridNormal.classList.add('active');
      gridSpecial.classList.remove('active');
      recalcUnitCount();
    });

    btnSpecial.addEventListener('click', () => {
      btnSpecial.classList.add('active');
      btnNormal.classList.remove('active');
      gridSpecial.classList.add('active');
      gridNormal.classList.remove('active');
      recalcUnitCount();
    });

    recalcUnitCount();
    attachCellHandlers(document);
    attachPaletteHandlers();
    attachPaletteTabsHandlers();
    attachTrashHandlers();
    attachCellDragStart();

    const btnClearAll = document.getElementById('btnClearAll');
    if (btnClearAll) {
      btnClearAll.addEventListener('click', () => {
        clearActiveBoard();
      });
    }
  </script>
</body>
</html>

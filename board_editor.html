<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„É©„ÉÉ„Ç≠„ÉºÂÇ≠ÂÖµÂõ£ Áõ§Èù¢„Ç®„Éá„Ç£„ÇøÔºà„Éâ„É©„ÉÉ„Ç∞ÂØæÂøú„É¢„ÉÉ„ÇØ v2Ôºâ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #fafafa;
      --card-bg: #ffffff;
      --border: #dddddd;
      --text-main: #222222;
      --text-sub: #666666;
      --accent: #3874ff;
      --accent-soft: #e7f0ff;
      --danger: #d33;
      --grid-border: #cccccc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP",
        "Noto Sans", "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
    }
    .app {
      max-width: 420px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      background-color: var(--bg);
    }
    header.app-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      background-color: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .app-title {
      font-size: 14px;
      font-weight: 600;
    }
    .unit-count-global {
      font-size: 11px;
      color: var(--text-sub);
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 6px;
      gap: 6px;
    }
    .board-toggle {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
    }
    .board-toggle button {
      flex: 1;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #ffffff;
      cursor: pointer;
    }
    .board-toggle button.active {
      background-color: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }
    .board-wrapper {
      background-color: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px;
    }
    .board-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .board {
      width: 100%;
      max-width: 380px;
      margin: 0 auto;
    }
    .grid-normal,
    .grid-special {
      display: none;
    }
    .grid-normal.active,
    .grid-special.active {
      display: grid;
    }
    .grid-normal {
      grid-template-columns: repeat(6, 1fr);
      grid-auto-rows: 40px;
      gap: 2px;
      margin-bottom: 4px;
    }
    .grid-special {
      grid-template-columns: repeat(6, 1fr);
      grid-auto-rows: 40px;
      gap: 2px;
      margin-bottom: 4px;
    }
    .cell {
      border: 1px solid var(--grid-border);
      border-radius: 4px;
      background-color: #fdfdfd;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-main);
      cursor: pointer;
      overflow: hidden;
    }
    .cell.empty {
      background-color: #f7f7f7;
      color: #bbbbbb;
      font-size: 9px;
    }
    .cell img.unit-img-basic {
      width: 30px;
      height: 30px;
      object-fit: contain;
      pointer-events: none;
    }
    .cell img.unit-img-special {
      width: 40px;
      height: 40px;
      object-fit: contain;
      pointer-events: none;
    }
    .cell .unit-count-badge {
      position: absolute;
      right: 2px;
      bottom: 1px;
      font-size: 10px;
      font-weight: 600;
      background: rgba(255,255,255,0.9);
      padding: 0 3px;
      border-radius: 999px;
      border: 1px solid #dddddd;
    }
    .label-row {
      grid-column: 1 / span 3;
      border: 1px dashed var(--grid-border);
      border-radius: 4px;
      background-color: #f3f3f3;
      font-size: 10px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    .trash-area {
      margin-top: 2px;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }
    .trash-left {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .trash-box {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #f8f8f8;
      padding: 2px 8px;
      font-size: 11px;
      min-width: 140px;
    }
    .trash-box.drag-over {
      border-color: var(--danger);
      background-color: #ffecec;
      color: var(--danger);
    }
    .palette-wrapper {
      background-color: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px;
    }
    .palette-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
    }
    .palette-tabs button {
      flex: 1;
      font-size: 11px;
      padding: 4px 0;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #ffffff;
      cursor: pointer;
    }
    .palette-tabs button.active {
      background-color: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }
    .palette-list {
      display: flex;
      gap: 4px;
      overflow-x: auto;
      padding-bottom: 2px;
    }
    .palette-item {
      min-width: 40px;
      height: 40px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: #f7f7ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      cursor: grab;
      overflow: hidden;
    }
    .palette-item img.unit-img-basic,
    .palette-item img.unit-img-special {
      pointer-events: none;
    }
    
    .cell.selected {
      outline: 2px solid #ff4d4d;
      outline-offset: -2px;
    }
    .palette-item.selected {
      outline: 2px solid #ff4d4d;
      outline-offset: -1px;
    }
    @keyframes ld-shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      50% { transform: translateX(2px); }
      75% { transform: translateX(-2px); }
      100% { transform: translateX(0); }
    }
    .shake {
      animation: ld-shake 0.2s;
    }
    /* „Çπ„Éû„Éõ„Åß„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÈÅ∏Êäû„ÇÑÁîªÂÉèÈï∑Êäº„Åó„ÇíÊäëÂà∂ */
    body, .board, .palette-wrapper, .palette-item, .cell {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    img {
      -webkit-user-drag: none;
    }
.inspector-wrapper {
      background-color: #ffffff;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px;
      font-size: 11px;
      min-height: 56px;
    }
    .inspector-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
    }
    .inspector-body {
      font-size: 11px;
      color: var(--text-sub);
    }
    .inspector-actions {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .btn-small {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background-color: #ffffff;
      cursor: pointer;
    }
    .btn-small.primary {
      border-color: var(--accent);
      background-color: var(--accent-soft);
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">Áõ§Èù¢„Ç®„Éá„Ç£„ÇøÔºà„Éâ„É©„ÉÉ„Ç∞ÂØæÂøú„É¢„ÉÉ„ÇØ v2Ôºâ</div>
      <div id="unitCountLabel" class="unit-count-global">„É¶„Éã„ÉÉ„ÉàÊï∞: 0 / 30</div>
    </header>

    <main>
      <!-- Áõ§Èù¢ -->
      <section class="board-wrapper">
        <div class="board-label">
          <span>Áõ§Èù¢</span>
          <div class="board-toggle">
            <button id="btnNormal" class="active">ÈÄöÂ∏∏Áõ§Èù¢</button>
            <button id="btnSpecial">ÁâπÊÆäÁõ§Èù¢</button>
          </div>
        </div>

        <div class="board">
          <!-- ÈÄöÂ∏∏Áõ§Èù¢ -->
          <div id="gridNormal" class="grid-normal active">
            <div class="cell empty" data-x="0" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="label-row">
              <span>„ÉÄ„É≥„Ç∏„Éß„É≥„ÇÑÁ•û„ÅÆÁ•†Áî®‚Üí</span>
            </div>
            <div class="cell empty" data-x="3" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
          </div>

          <!-- ÁâπÊÆäÁõ§Èù¢Ôºà5Ë°å√ó6ÂàóÔºâ -->
          <div id="gridSpecial" class="grid-special">
            <div class="cell empty" data-x="0" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="0" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="1" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="2" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="3" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="0" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="1" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="2" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="3" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="4" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>
            <div class="cell empty" data-x="5" data-y="4" data-code="" data-kind="" data-count="0">Á©∫</div>

          </div>
        </div>

        <div class="trash-area">
          <div class="trash-left">
            <span>üóë</span>
            <span id="trashBox" class="trash-box">„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞„ÅßÂâäÈô§</span>
          </div>
          <button id="btnClearAll" class="btn-small">ÂÖ®„ÇØ„É™„Ç¢</button>
        </div>
      </section>

      <!-- „Éë„É¨„ÉÉ„Éà -->
      
      <!-- „Éë„É¨„ÉÉ„Éà -->
      <section class="palette-wrapper">
        <div class="palette-tabs">
          <button class="active" data-group="N">N</button>
          <button data-group="R">R</button>
          <button data-group="E">E</button>
          <button data-group="L">L</button>
          <button data-group="M">Á•û</button>
          <button data-group="I">‰∏ç</button>
          <button data-group="EX">EX</button>
        </div>
        <div class="palette-list">
          <div class="palette-item" draggable="true" data-code="101" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/101.png" alt="101" />
          </div>
          <div class="palette-item" draggable="true" data-code="102" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/102.png" alt="102" />
          </div>
          <div class="palette-item" draggable="true" data-code="103" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/103.png" alt="103" />
          </div>
          <div class="palette-item" draggable="true" data-code="104" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/104.png" alt="104" />
          </div>
          <div class="palette-item" draggable="true" data-code="105" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/105.png" alt="105" />
          </div>
          <div class="palette-item" draggable="true" data-code="106" data-group="N">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/106.png" alt="106" />
          </div>
          <div class="palette-item" draggable="true" data-code="201" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/201.png" alt="201" />
          </div>
          <div class="palette-item" draggable="true" data-code="202" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/202.png" alt="202" />
          </div>
          <div class="palette-item" draggable="true" data-code="203" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/203.png" alt="203" />
          </div>
          <div class="palette-item" draggable="true" data-code="204" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/204.png" alt="204" />
          </div>
          <div class="palette-item" draggable="true" data-code="205" data-group="R">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/205.png" alt="205" />
          </div>
          <div class="palette-item" draggable="true" data-code="301" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/301.png" alt="301" />
          </div>
          <div class="palette-item" draggable="true" data-code="302" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/302.png" alt="302" />
          </div>
          <div class="palette-item" draggable="true" data-code="303" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/303.png" alt="303" />
          </div>
          <div class="palette-item" draggable="true" data-code="304" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/304.png" alt="304" />
          </div>
          <div class="palette-item" draggable="true" data-code="305" data-group="E">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/305.png" alt="305" />
          </div>
          <div class="palette-item" draggable="true" data-code="401" data-group="L">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/401.png" alt="401" />
          </div>
          <div class="palette-item" draggable="true" data-code="402" data-group="L">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/402.png" alt="402" />
          </div>
          <div class="palette-item" draggable="true" data-code="403" data-group="L">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/403.png" alt="403" />
          </div>
          <div class="palette-item" draggable="true" data-code="404" data-group="L">
            <img class="unit-img-basic" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/404.png" alt="404" />
          </div>
          <div class="palette-item" draggable="true" data-code="501" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/501.png" alt="501" />
          </div>
          <div class="palette-item" draggable="true" data-code="502" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/502.png" alt="502" />
          </div>
          <div class="palette-item" draggable="true" data-code="503" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/503.png" alt="503" />
          </div>
          <div class="palette-item" draggable="true" data-code="504" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/504.png" alt="504" />
          </div>
          <div class="palette-item" draggable="true" data-code="505" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/505.png" alt="505" />
          </div>
          <div class="palette-item" draggable="true" data-code="506" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/506.png" alt="506" />
          </div>
          <div class="palette-item" draggable="true" data-code="507" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/507.png" alt="507" />
          </div>
          <div class="palette-item" draggable="true" data-code="508" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/508.png" alt="508" />
          </div>
          <div class="palette-item" draggable="true" data-code="509" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/509.png" alt="509" />
          </div>
          <div class="palette-item" draggable="true" data-code="510" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/510.png" alt="510" />
          </div>
          <div class="palette-item" draggable="true" data-code="511" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/511.png" alt="511" />
          </div>
          <div class="palette-item" draggable="true" data-code="512" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/512.png" alt="512" />
          </div>
          <div class="palette-item" draggable="true" data-code="513" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/513.png" alt="513" />
          </div>
          <div class="palette-item" draggable="true" data-code="514" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/514.png" alt="514" />
          </div>
          <div class="palette-item" draggable="true" data-code="515" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/515.png" alt="515" />
          </div>
          <div class="palette-item" draggable="true" data-code="516" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/516.png" alt="516" />
          </div>
          <div class="palette-item" draggable="true" data-code="517" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/517.png" alt="517" />
          </div>
          <div class="palette-item" draggable="true" data-code="518" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/518.png" alt="518" />
          </div>
          <div class="palette-item" draggable="true" data-code="519" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/519.png" alt="519" />
          </div>
          <div class="palette-item" draggable="true" data-code="520" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/520.png" alt="520" />
          </div>
          <div class="palette-item" draggable="true" data-code="521" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/521.png" alt="521" />
          </div>
          <div class="palette-item" draggable="true" data-code="522" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/522.png" alt="522" />
          </div>
          <div class="palette-item" draggable="true" data-code="523" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/523.png" alt="523" />
          </div>
          <div class="palette-item" draggable="true" data-code="524" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/524.png" alt="524" />
          </div>
          <div class="palette-item" draggable="true" data-code="525" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/525.png" alt="525" />
          </div>
          <div class="palette-item" draggable="true" data-code="526" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/526.png" alt="526" />
          </div>
          <div class="palette-item" draggable="true" data-code="527" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/527.png" alt="527" />
          </div>
          <div class="palette-item" draggable="true" data-code="528" data-group="M">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/528.png" alt="528" />
          </div>
          <div class="palette-item" draggable="true" data-code="601" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/601.png" alt="601" />
          </div>
          <div class="palette-item" draggable="true" data-code="602" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/602.png" alt="602" />
          </div>
          <div class="palette-item" draggable="true" data-code="604" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/604.png" alt="604" />
          </div>
          <div class="palette-item" draggable="true" data-code="606" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/606.png" alt="606" />
          </div>
          <div class="palette-item" draggable="true" data-code="609" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/609.png" alt="609" />
          </div>
          <div class="palette-item" draggable="true" data-code="611" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/611.png" alt="611" />
          </div>
          <div class="palette-item" draggable="true" data-code="613" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/613.png" alt="613" />
          </div>
          <div class="palette-item" draggable="true" data-code="614" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/614.png" alt="614" />
          </div>
          <div class="palette-item" draggable="true" data-code="615a" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/615_a.png" alt="615a" />
          </div>
          <div class="palette-item" draggable="true" data-code="615b" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/615_b.png" alt="615b" />
          </div>
          <div class="palette-item" draggable="true" data-code="616" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/616.png" alt="616" />
          </div>
          <div class="palette-item" draggable="true" data-code="625" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/625.png" alt="625" />
          </div>
          <div class="palette-item" draggable="true" data-code="626" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/626.png" alt="626" />
          </div>
          <div class="palette-item" draggable="true" data-code="627" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/627.png" alt="627" />
          </div>
          <div class="palette-item" draggable="true" data-code="628" data-group="I">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/628.png" alt="628" />
          </div>
          <div class="palette-item" draggable="true" data-code="709" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/709.png" alt="709" />
          </div>
          <div class="palette-item" draggable="true" data-code="710" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/710.png" alt="710" />
          </div>
          <div class="palette-item" draggable="true" data-code="711" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/711.png" alt="711" />
          </div>
          <div class="palette-item" draggable="true" data-code="712" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/712.png" alt="712" />
          </div>
          <div class="palette-item" draggable="true" data-code="713" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/713.png" alt="713" />
          </div>
          <div class="palette-item" draggable="true" data-code="714" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/714.png" alt="714" />
          </div>
          <div class="palette-item" draggable="true" data-code="715" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/715.png" alt="715" />
          </div>
          <div class="palette-item" draggable="true" data-code="720" data-group="EX">
            <img class="unit-img-special" src="https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/720.png" alt="720" />
          </div>
        </div>
      </section>


      <!-- „Ç§„É≥„Çπ„Éö„ÇØ„Çø -->
      <section class="inspector-wrapper">
        <div class="inspector-title">„Éû„Çπ„ÅÆÊÉÖÂ†±</div>
        <div id="inspectorBody" class="inspector-body">
          „Éû„Çπ„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Êìç‰Ωú„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
        </div>
        <div id="inspectorActions" class="inspector-actions"></div>
      </section>
    </main>
  </div>

  <script>
    function parseCodeNumber(code) {
      if (!code) return NaN;
      const m = String(code).match(/\d+/);
      return m ? parseInt(m[0], 10) : NaN;
    }

    let currentPaletteCode = null;

    function getActiveGrid() {
      const normal = document.getElementById('gridNormal');
      const special = document.getElementById('gridSpecial');
      if (normal.classList.contains('active')) return normal;
      return special;
    }

    function getBoardUnitCount() {
      const grid = getActiveGrid();
      let total = 0;
      grid.querySelectorAll('.cell').forEach(cell => {
        if (cell.classList.contains('label-row')) return;
        const code = cell.dataset.code;
        if (!code) return;
        const count = parseInt(cell.dataset.count || '0', 10);
        const n = parseCodeNumber(code);
        if (n >= 100 && n < 500) {
          total += count;
        } else {
          total += 1;
        }
      });
      return total;
    }

    function recalcUnitCount() {
      const total = getBoardUnitCount();
      document.getElementById('unitCountLabel').textContent =
        '„É¶„Éã„ÉÉ„ÉàÊï∞: ' + total + ' / 30';
    }

    function makeEmptyCell(cell) {
      cell.dataset.code = '';
      cell.dataset.kind = '';
      cell.dataset.count = '0';
      cell.classList.add('empty');
      cell.removeAttribute('draggable');
      cell.style.backgroundColor = '#f7f7f7';
      cell.innerHTML = 'Á©∫';
    }


    function clearActiveBoard() {
      const grid = getActiveGrid();
      grid.querySelectorAll('.cell').forEach(cell => {
        if (cell.classList.contains('label-row')) return;
        makeEmptyCell(cell);
      });
      recalcUnitCount();
      const inspectorBody = document.getElementById('inspectorBody');
      const inspectorActions = document.getElementById('inspectorActions');
      if (inspectorBody) {
        inspectorBody.textContent = '„Éû„Çπ„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Êìç‰Ωú„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ';
      }
      if (inspectorActions) {
        inspectorActions.innerHTML = '';
      }
    }

    function isBasicCode(code) {
      const n = parseCodeNumber(code);
      return n >= 100 && n < 500;
    }

    function getKindFromCode(code) {
      const n = parseCodeNumber(code);
      if (code === '615a' || code === '615b') return 'immortal-variant';

      const awakenable = [501, 502, 504, 506, 509, 511, 513, 514, 515, 516, 525, 526, 527, 528];
      if (awakenable.indexOf(n) !== -1) return 'mythic-awakable';

      if (n >= 100 && n < 500) return 'basic';
      if (n >= 500 && n < 600) return 'mythic';
      if (n >= 600 && n < 700) return 'immortal';
      return 'extra';
    }


    function renderCellContent(cell) {
      const code = cell.dataset.code;
      const count = parseInt(cell.dataset.count || '0', 10);

      if (!code) {
        makeEmptyCell(cell);
        return;
      }

      cell.classList.remove('empty');
      cell.setAttribute('draggable', 'true');

      const n = parseCodeNumber(code);
      const isBasic = n >= 100 && n < 500;
      const imgClass = isBasic ? 'unit-img-basic' : 'unit-img-special';

      // kind „Å®ËÉåÊôØËâ≤
      const kind = getKindFromCode(code);
      cell.dataset.kind = kind || '';

      let bg = '#fdfdfd';
      if (kind === 'basic') {
        if (n >= 100 && n < 200) {
          bg = '#AFA68C'; // „Éé„Éº„Éû„É´
        } else if (n >= 200 && n < 300) {
          bg = '#3F4C82'; // „É¨„Ç¢
        } else if (n >= 300 && n < 400) {
          bg = '#683A8E'; // „Ç®„Éî„ÉÉ„ÇØ
        } else if (n >= 400 && n < 500) {
          bg = '#D2A349'; // „É¨„Ç∏„Çß„É≥„Éâ
        }
      } else if (kind === 'mythic' || kind === 'mythic-awakable') {
        bg = '#C58540'; // Á•ûË©±
      } else if (kind === 'immortal' || kind === 'immortal-variant') {
        bg = '#AF453A'; // ‰∏çÊªÖ
      } else if (kind === 'extra') {
        bg = '#ADB34D'; // EX
      }
      cell.style.backgroundColor = bg;

      let src = '';
      if (code === '615a') src = 'https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/615_a.png';
      else if (code === '615b') src = 'https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/615_b.png';
      else src = 'https://teggcuiyqkbcvbhdntni.supabase.co/storage/v1/object/public/ld-assets/unit_icons/' + parseCodeNumber(code) + '.png';

      let html = '<img class="' + imgClass + '" src="' + src + '" alt="' + code + '" />';
      if (isBasic) {
        html += '<span class="unit-count-badge">' + count + '</span>';
      }
      cell.innerHTML = html;
    }


    function findCell(x, y, root) {
      const selector = '.cell[data-x="' + x + '"][data-y="' + y + '"]';
      return (root || document).querySelector(selector);
    }

    function updateInspectorFromCell(cell) {
      const inspectorBody = document.getElementById('inspectorBody');
      const inspectorActions = document.getElementById('inspectorActions');
      inspectorActions.innerHTML = '';

      const code = cell.dataset.code;
      const kind = cell.dataset.kind || '';
      const count = parseInt(cell.dataset.count || '0', 10);

      if (!code) {
        inspectorBody.textContent = 'Á©∫„ÅÆ„Éû„Çπ„Åß„Åô„ÄÇ';
        return;
      }

      if (kind === 'basic') {
        inspectorBody.textContent = code + 'ÔºàÂü∫Êú¨„É¶„Éã„ÉÉ„ÉàÔºâ: ' + count + '‰Ωì';

        const btnMinus = document.createElement('button');
        btnMinus.textContent = (count <= 1 ? 'ÂâäÈô§' : '-');
        btnMinus.className = 'btn-small';
        btnMinus.addEventListener('click', () => {
          let c = parseInt(cell.dataset.count || '0', 10);
          const code = cell.dataset.code;

          // 3‰Ωì‚Üí2‰Ωì„Å´Ê∏õ„Çâ„Åô„Å®„Åç„ÄÅÂêåÁ®Æ„É¶„Éã„ÉÉ„Éà„ÅåÂà•„Éû„Çπ„Å´Â≠òÂú®„Åô„Çã„Å™„ÇâÁ¶ÅÊ≠¢
          if (c === 3) {
            const grid = getActiveGrid();
            let hasOther = false;
            grid.querySelectorAll('.cell').forEach(other => {
              if (other === cell) return;
              if (other.classList.contains('label-row')) return;
              if (other.dataset.code !== code) return;
              const oc = parseInt(other.dataset.count || '0', 10);
              if (oc > 0) {
                hasOther = true;
              }
            });
            if (hasOther) {
              return;
            }
          }

          if (c > 1) {
            c -= 1;
            cell.dataset.count = String(c);
          } else {
            makeEmptyCell(cell);
          }
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });
        inspectorActions.appendChild(btnMinus);

        const btnPlus = document.createElement('button');
        btnPlus.className = 'btn-small';
        const totalNow = getBoardUnitCount();
        if (totalNow >= 30 && count < 3) {
          btnPlus.textContent = 'Ê∫ÄÂì°';
        } else {
          btnPlus.textContent = '+';
        }
        btnPlus.addEventListener('click', () => {
          let c = parseInt(cell.dataset.count || '0', 10);
          if (c >= 3) return;
          const total = getBoardUnitCount();
          if (total >= 30) {
            // Ê∫ÄÂì°Ôºö„Éú„Çø„É≥„ÇíÈúá„Åà„Åï„Åõ„Çã
            btnPlus.classList.remove('shake');
            void btnPlus.offsetWidth;
            btnPlus.classList.add('shake');
            return;
          }
          c += 1;
          cell.dataset.count = String(c);
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });
        inspectorActions.appendChild(btnPlus);

      } else if (kind === 'mythic-awakable' && code === '515') {
        inspectorBody.textContent = code + 'ÔºàÁ•ûË©±ÔºâÔºöË¶öÈÜíÂÖà„ÇíÈÅ∏„Åπ„Åæ„Åô';

        const btnAwBatter = document.createElement('button');
        btnAwBatter.textContent = 'Ë¶öÈÜí(ÊâìËÄÖ)';
        btnAwBatter.className = 'btn-small primary';
        btnAwBatter.addEventListener('click', () => {
          if (hasOtherImmortalVariant(cell)) {
            return;
          }
          cell.dataset.code = '615a';
          cell.dataset.kind = 'immortal-variant';
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });
        inspectorActions.appendChild(btnAwBatter);

        const btnAwPitcher = document.createElement('button');
        btnAwPitcher.textContent = 'Ë¶öÈÜí(ÊäïÊâã)';
        btnAwPitcher.className = 'btn-small primary';
        btnAwPitcher.addEventListener('click', () => {
          if (hasOtherImmortalVariant(cell)) {
            return;
          }
          cell.dataset.code = '615b';
          cell.dataset.kind = 'immortal-variant';
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });
        inspectorActions.appendChild(btnAwPitcher);

      } else if (kind === 'mythic-awakable') {
        // Ë¶öÈÜíÂèØËÉΩ„Å™„Åù„ÅÆ‰ªñ„ÅÆÁ•ûË©±Ôºà501,502,504,...„Å™„Å©Ôºâ
        inspectorBody.textContent = code + 'ÔºàÁ•ûË©±ÔºâÔºöË¶öÈÜí„Åß‰∏çÊªÖ„Å´„Åß„Åç„Åæ„Åô';

        const btnAw = document.createElement('button');
        btnAw.textContent = 'Ë¶öÈÜí';
        btnAw.className = 'btn-small primary';
        btnAw.addEventListener('click', () => {
          const n = parseCodeNumber(code);
          const immortalCode = String(n + 100);
          cell.dataset.code = immortalCode;
          cell.dataset.kind = getKindFromCode(immortalCode);
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });
        inspectorActions.appendChild(btnAw);

      } else if (kind === 'immortal-variant') {
        inspectorBody.textContent = code + 'Ôºà‰∏çÊªÖÔºâÔºöÈÄÄÂåñ„ÅßÁ•ûË©±„Å´Êàª„Åõ„Åæ„Åô';

        const btnDevolve = document.createElement('button');
        btnDevolve.textContent = 'ÈÄÄÂåñ';
        btnDevolve.className = 'btn-small';
        btnDevolve.addEventListener('click', () => {
          cell.dataset.code = '515';
          cell.dataset.kind = 'mythic-awakable';
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });
        inspectorActions.appendChild(btnDevolve);

      } else if (kind === 'immortal') {
        inspectorBody.textContent = code + 'Ôºà‰∏çÊªÖÔºâÔºöÈÄÄÂåñ„ÅßÁ•ûË©±„Å´Êàª„Åõ„Åæ„Åô';

        const btnDevolve = document.createElement('button');
        btnDevolve.textContent = 'ÈÄÄÂåñ';
        btnDevolve.className = 'btn-small';
        btnDevolve.addEventListener('click', () => {
          const n = parseCodeNumber(code);
          const mythicCode = String(n - 100);
          cell.dataset.code = mythicCode;
          cell.dataset.kind = getKindFromCode(mythicCode);
          cell.dataset.count = '1';
          renderCellContent(cell);
          recalcUnitCount();
          updateInspectorFromCell(cell);
        });
        inspectorActions.appendChild(btnDevolve);

      } else {
        inspectorBody.textContent = code + 'ÔºàÁâπÊÆä„É¶„Éã„ÉÉ„ÉàÔºâ: ÁâπÂà•„Å™Êìç‰Ωú„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì';
      }
    }


    function canPlaceBasicIntoNewCell(code) {
      const grid = getActiveGrid();
      let has1or2 = false;
      grid.querySelectorAll('.cell').forEach(cell => {
        if (cell.classList.contains('label-row')) return;
        if (cell.dataset.code !== code) return;
        const c = parseInt(cell.dataset.count || '0', 10);
        if (c === 1 || c === 2) {
          has1or2 = true;
        }
      });
      if (has1or2) return false;

      const total = getBoardUnitCount();
      if (total >= 30) return false;

      return true;
    }

    function canAddNewUnit() {
      const total = getBoardUnitCount();
      return total < 30;
    }

    function hasOtherImmortalVariant(targetCell) {
      const grid = getActiveGrid();
      let blocked = false;
      grid.querySelectorAll('.cell').forEach(other => {
        if (other === targetCell) return;
        if (other.classList.contains('label-row')) return;
        const oc = other.dataset.code;
        if (oc === '615a' || oc === '615b') {
          blocked = true;
        }
      });
      return blocked;
    }

    function attachCellHandlers(root) {
      const cells = root.querySelectorAll('.cell');
      cells.forEach(cell => {
        if (cell.classList.contains('label-row')) return;

        cell.addEventListener('click', () => {
          if (cell.classList.contains('label-row')) return;

          // „Éë„É¨„ÉÉ„ÉàÈÅ∏Êäû‰∏≠„Å™„Çâ„Çø„ÉÉ„Éó„ÅßÈÖçÁΩÆ„ÉªÂ¢óÂä†„ÇÇË°å„ÅÜ
          if (currentPaletteCode) {
            const selCode = currentPaletteCode;
            const n = parseCodeNumber(selCode);
            const isBasic = n >= 100 && n < 500;

            if (selCode === '615a' || selCode === '615b') {
              if (hasOtherImmortalVariant(cell)) {
                // „Åô„Åß„Å´Âà•„Éû„Çπ„Å´615a/b„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
              } else {
                if (!cell.dataset.code) {
                  if (canAddNewUnit()) {
                    cell.dataset.code = selCode;
                    cell.dataset.kind = getKindFromCode(selCode);
                    cell.dataset.count = '1';
                    renderCellContent(cell);
                    recalcUnitCount();
                  }
                }
              }
            } else {
              const currentCode = cell.dataset.code || '';
              const currentCount = parseInt(cell.dataset.count || '0', 10);

              if (!currentCode) {
                if (isBasic) {
                  if (canPlaceBasicIntoNewCell(selCode)) {
                    cell.dataset.code = selCode;
                    cell.dataset.kind = getKindFromCode(selCode);
                    cell.dataset.count = '1';
                    renderCellContent(cell);
                    recalcUnitCount();
                  }
                } else {
                  if (canAddNewUnit()) {
                    cell.dataset.code = selCode;
                    cell.dataset.kind = getKindFromCode(selCode);
                    cell.dataset.count = '1';
                    renderCellContent(cell);
                    recalcUnitCount();
                  }
                }
              } else if (isBasic && currentCode === selCode && isBasicCode(currentCode)) {
                if (currentCount < 3 && canAddNewUnit()) {
                  cell.dataset.count = String(currentCount + 1);
                  renderCellContent(cell);
                  recalcUnitCount();
                }
              }
            }
          }

          // „Éû„ÇπÈÅ∏Êäû„ÅÆËµ§Êû†Ôºö„Éû„ÇπÂÅ¥„Å†„ÅëÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åó„ÄÅ„Éë„É¨„ÉÉ„Éà„ÅÆËµ§Êû†„ÅØËß£Èô§
          document.querySelectorAll('.palette-item.selected').forEach(p => p.classList.remove('selected'));
          document.querySelectorAll('.cell.selected').forEach(c => c.classList.remove('selected'));
          cell.classList.add('selected');

          updateInspectorFromCell(cell);
        });

        cell.addEventListener('dragover', (e) => {
          e.preventDefault();
        });

        cell.addEventListener('drop', (e) => {
          e.preventDefault();
          const raw = e.dataTransfer.getData('text/plain') || '';
          if (!raw) return;
          let data;
          try { data = JSON.parse(raw); } catch { return; }
          const target = cell;
          if (target.classList.contains('label-row')) return;

          if (data.source === 'palette') {
            const code = data.code;
            const n = parseCodeNumber(code);
            const isBasic = n >= 100 && n < 500;

            // 615a/615b „ÅØÁõ§Èù¢„Å´ÂêåÊôÇÂÖ±Â≠ò‰∏çÂèØÔºàÊúÄÂ§ß1„Éû„Çπ„Å†„ÅëÔºâ
            if (code === '615a' || code === '615b') {
              if (hasOtherImmortalVariant(target)) {
                return;
              }
            }

            const currentCode = target.dataset.code;
            const currentCount = parseInt(target.dataset.count || '0', 10);

            if (!currentCode) {
              if (isBasic) {
                if (!canPlaceBasicIntoNewCell(code)) {
                  return;
                }
                target.dataset.code = code;
                target.dataset.kind = getKindFromCode(code);
                target.dataset.count = '1';
                renderCellContent(target);
              } else {
                if (!canAddNewUnit()) {
                  return;
                }
                target.dataset.code = code;
                target.dataset.kind = getKindFromCode(code);
                target.dataset.count = '1';
                renderCellContent(target);
              }
            } else if (isBasic && currentCode === code && isBasicCode(currentCode)) {
              if (currentCount < 3) {
                if (!canAddNewUnit()) {
                  return;
                }
                target.dataset.count = String(currentCount + 1);
                renderCellContent(target);
              }
            } else {
              // ‰ªñ„É¶„Éã„ÉÉ„Éà„Åå„ÅÑ„Çã„Éû„Çπ„Å´„ÅØ‰ªä„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            }

            recalcUnitCount();
          } else if (data.source === 'cell') {
            const src = findCell(data.x, data.y, document);
            if (!src || src === target) return;
            if (target.classList.contains('label-row')) return;

            const srcCode = src.dataset.code;
            const srcKind = src.dataset.kind;
            const srcCount = src.dataset.count;
            const srcEmpty = src.classList.contains('empty');

            const tgtCode = target.dataset.code;
            const tgtKind = target.dataset.kind;
            const tgtCount = target.dataset.count;
            const tgtEmpty = target.classList.contains('empty');

            src.dataset.code = tgtCode;
            src.dataset.kind = tgtKind;
            src.dataset.count = tgtCount || '0';
            target.dataset.code = srcCode;
            target.dataset.kind = srcKind;
            target.dataset.count = srcCount || '0';

            if (tgtEmpty) src.classList.add('empty'); else src.classList.remove('empty');
            if (srcEmpty) target.classList.add('empty'); else target.classList.remove('empty');

            if (src.dataset.code) src.setAttribute('draggable', 'true');
            else src.removeAttribute('draggable');
            if (target.dataset.code) target.setAttribute('draggable', 'true');
            else target.removeAttribute('draggable');

            renderCellContent(src);
            renderCellContent(target);

            recalcUnitCount();
          }
        });
      });
    }

    function attachPaletteHandlers() {
      const items = document.querySelectorAll('.palette-item');

      function clearPaletteSelection() {
        items.forEach(it => it.classList.remove('selected'));
      }

      items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          const code = item.dataset.code;
          const payload = { source: 'palette', code };
          e.dataTransfer.setData('text/plain', JSON.stringify(payload));
        });

        item.addEventListener('click', () => {
          const code = item.dataset.code;

          // „Éû„ÇπÂÅ¥„ÅÆÈÅ∏ÊäûÊû†„ÅØËß£Èô§„Åó„Å¶„ÄÅ„Éë„É¨„ÉÉ„ÉàÂÅ¥„Å†„Åë„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
          document.querySelectorAll('.cell.selected').forEach(c => c.classList.remove('selected'));

          if (currentPaletteCode === code) {
            currentPaletteCode = null;
            clearPaletteSelection();
          } else {
            currentPaletteCode = code;
            clearPaletteSelection();
            item.classList.add('selected');
          }
        });
      });
    }



    function attachPaletteTabsHandlers() {
      const tabs = document.querySelectorAll('.palette-tabs button');
      const items = document.querySelectorAll('.palette-item');

      function update(group) {
        items.forEach(item => {
          if (item.dataset.group === group) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      }

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          update(tab.dataset.group);
        });
      });

      const active = document.querySelector('.palette-tabs button.active');
      if (active) {
        update(active.dataset.group);
      }
    }

    function attachTrashHandlers() {
      const trash = document.getElementById('trashBox');
      trash.addEventListener('dragover', (e) => {
        e.preventDefault();
        trash.classList.add('drag-over');
      });
      trash.addEventListener('dragleave', () => {
        trash.classList.remove('drag-over');
      });
      trash.addEventListener('drop', (e) => {
        e.preventDefault();
        trash.classList.remove('drag-over');
        const raw = e.dataTransfer.getData('text/plain') || '';
        if (!raw) return;
        let data;
        try { data = JSON.parse(raw); } catch { return; }
        if (data.source === 'cell') {
          const src = findCell(data.x, data.y, document);
          if (!src) return;
          makeEmptyCell(src);
          recalcUnitCount();
        }
      });
    }

    function attachCellDragStart() {
      document.querySelectorAll('#gridNormal .cell, #gridSpecial .cell').forEach(cell => {
        if (cell.classList.contains('label-row')) return;
        cell.addEventListener('dragstart', (e) => {
          if (!cell.dataset.code) {
            e.preventDefault();
            return;
          }
          const payload = { source: 'cell', x: cell.dataset.x, y: cell.dataset.y };
          e.dataTransfer.setData('text/plain', JSON.stringify(payload));
        });
      });
    }

    const btnNormal = document.getElementById('btnNormal');
    const btnSpecial = document.getElementById('btnSpecial');
    const gridNormal = document.getElementById('gridNormal');
    const gridSpecial = document.getElementById('gridSpecial');

    btnNormal.addEventListener('click', () => {
      btnNormal.classList.add('active');
      btnSpecial.classList.remove('active');
      gridNormal.classList.add('active');
      gridSpecial.classList.remove('active');
      recalcUnitCount();
    });

    btnSpecial.addEventListener('click', () => {
      btnSpecial.classList.add('active');
      btnNormal.classList.remove('active');
      gridSpecial.classList.add('active');
      gridNormal.classList.remove('active');
      recalcUnitCount();
    });

    recalcUnitCount();
    attachCellHandlers(document);
    attachPaletteHandlers();
    attachPaletteTabsHandlers();
    attachTrashHandlers();
    attachCellDragStart();

    const btnClearAll = document.getElementById('btnClearAll');
    if (btnClearAll) {
      btnClearAll.addEventListener('click', () => {
        clearActiveBoard();
      });
    }
  </script>
</body>
</html>
